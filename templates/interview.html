{% extends "base.html" %}
{% block content %}

<h2 class="mb-4">AI Interview Session</h2>

<!-- â³ Interview Timer -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Time Remaining:</h5>
    <h4 id="countdown-timer" class="text-danger fw-bold">
    {{ "%02d:00"|format(interview_duration) }}
</h4>

</div>

<div class="card p-4 shadow">

    <!-- ðŸŽ¥ Camera Preview -->
    <video id="video"
           width="100%"
           height="300"
           autoplay
           muted
           playsinline
           style="border-radius:10px; background:black;">
    </video>

    <hr>

    <!-- ðŸ¤– Question Display -->
    <h5>Interview Question</h5>
    <div id="question-box" class="alert alert-info">
        Preparing your AI interview...
    </div>

    <!-- ðŸ—£ Candidate Answer -->
    <h5>Your Answer</h5>
    <textarea id="answerBox"
              class="form-control"
              rows="4"
              placeholder="Your spoken answer will appear here..."
              readonly></textarea>

    <br>

    <button id="startBtn"
            onclick="startInterview({{ result.id }})"
            class="btn btn-success">
        Start Interview
    </button>

</div>

<script>

const candidateName = "{{ candidate.name }}";

let recognition;
let silenceTimer;
let hardQuestionTimer;
let countdownInterval;

let isAnswering = false;
let interviewStarted = false;

const TOTAL_INTERVIEW_MINUTES = {{ interview_duration }};
const QUESTION_TIME = TOTAL_INTERVIEW_MINUTES <= 2 ? 15000 : 25000;
const SILENCE_LIMIT = 5000;

let totalInterviewSeconds = TOTAL_INTERVIEW_MINUTES * 60;

const questionBox = document.getElementById("question-box");
const answerBox = document.getElementById("answerBox");
const video = document.getElementById("video");
const timerDisplay = document.getElementById("countdown-timer");


/* =========================================
   ðŸ”Š SPEAK
========================================= */

function speak(text, callback=null) {

    window.speechSynthesis.cancel();

    const speech = new SpeechSynthesisUtterance(text);
    speech.rate = 1;
    speech.pitch = 1;

    speech.onend = function() {
        if (callback) callback();
    };

    window.speechSynthesis.speak(speech);
}


/* =========================================
   â³ COUNTDOWN TIMER
========================================= */

function startCountdown() {

    if (countdownInterval) clearInterval(countdownInterval);

    totalInterviewSeconds = TOTAL_INTERVIEW_MINUTES * 60;

    countdownInterval = setInterval(() => {

        let minutes = Math.floor(totalInterviewSeconds / 60);
        let seconds = totalInterviewSeconds % 60;

        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        timerDisplay.innerText = minutes + ":" + seconds;

        if (totalInterviewSeconds <= 10) {
            timerDisplay.classList.remove("text-danger");
            timerDisplay.classList.add("text-warning");
        }

        if (totalInterviewSeconds <= 5) {
            timerDisplay.classList.remove("text-warning");
            timerDisplay.classList.add("text-danger");
        }

        if (totalInterviewSeconds <= 0) {
            clearInterval(countdownInterval);
            forceInterviewEnd();
        }

        totalInterviewSeconds--;

    }, 1000);
}


/* =========================================
   ðŸ”´ FORCE END
========================================= */

function forceInterviewEnd() {

    if (recognition) recognition.stop();
    clearTimeout(silenceTimer);
    clearTimeout(hardQuestionTimer);

    questionBox.innerText = "Interview Completed. Thank you!";
    speak("Interview completed. Thank you.");

    isAnswering = false;
}


/* =========================================
   ðŸŽ¥ CAMERA
========================================= */

async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        video.srcObject = stream;
    } catch (err) {
        alert("Camera & Microphone permission required!");
    }
}


/* =========================================
   â³ HARD QUESTION TIMER
========================================= */

function startHardTimer(resultId) {

    clearTimeout(hardQuestionTimer);

    hardQuestionTimer = setTimeout(() => {
        moveToNextQuestion(resultId, answerBox.value);
    }, QUESTION_TIME);
}


/* =========================================
   ðŸŽ¤ LISTENING
========================================= */

function startListening(resultId) {

    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "en-US";
    recognition.continuous = true;
    recognition.interimResults = false;

    let finalTranscript = "";
    isAnswering = true;

    startHardTimer(resultId);

    recognition.onresult = function(event) {

        finalTranscript += event.results[event.results.length - 1][0].transcript + " ";
        answerBox.value = finalTranscript;

        clearTimeout(silenceTimer);

        silenceTimer = setTimeout(() => {
            moveToNextQuestion(resultId, finalTranscript);
        }, SILENCE_LIMIT);
    };

    recognition.onerror = function() {
        moveToNextQuestion(resultId, finalTranscript);
    };

    recognition.onend = function() {
        if (isAnswering) {
            moveToNextQuestion(resultId, finalTranscript);
        }
    };

    recognition.start();
}


/* =========================================
   âž¡ NEXT QUESTION
========================================= */

function moveToNextQuestion(resultId, lastAnswer) {

    if (!isAnswering) return;

    isAnswering = false;

    if (recognition) recognition.stop();
    clearTimeout(silenceTimer);
    clearTimeout(hardQuestionTimer);

    fetch("/generate-next-question", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body:
            `result_id=${resultId}` +
            `&last_answer=${encodeURIComponent(lastAnswer)}`
    })
    .then(res => res.json())
    .then(data => {

        if (!data || !data.question) {
            questionBox.innerText = "Error generating question.";
            return;
        }

        if (data.question === "INTERVIEW_COMPLETE") {
            forceInterviewEnd();
            return;
        }

        questionBox.innerText = data.question;
        answerBox.value = "";

        speak(data.question, () => {
            startListening(resultId);
        });
    });
}


/* =========================================
   ðŸš€ START INTERVIEW
========================================= */

function startInterview(resultId) {

    if (interviewStarted) return;
    interviewStarted = true;

    // ðŸ‘‡ Intro played AFTER user interaction (allowed by browser)
    const introText = `Hello ${candidateName}. 
    Welcome to your AI technical interview session. 
    Let us begin.`;

    speak(introText, () => {

        startCamera();
        startCountdown();

        fetch("/generate-next-question", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `result_id=${resultId}&last_answer=`
        })
        .then(res => res.json())
        .then(data => {

            if (!data || !data.question) {
                questionBox.innerText = "Error generating question.";
                return;
            }

            questionBox.innerText = data.question;

            speak(data.question, () => {
                startListening(resultId);
            });
        });

    });
}

</script>
{% endblock %}
