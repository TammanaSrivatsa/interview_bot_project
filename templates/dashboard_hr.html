{% extends "base.html" %}

{% block content %}

<h2 class="mb-4">HR Dashboard</h2>

<!-- âœ… SUCCESS MESSAGE -->
{% if success_message %}
<div id="success-alert"
     class="alert alert-success mt-3">
    {{ success_message }}
</div>
{% endif %}

<div class="card shadow p-4 mb-4">
    <h5 class="mb-3">Upload Job Description</h5>

    <form action="/upload_jd" method="post" enctype="multipart/form-data">

        <label class="form-label">Upload JD File</label>
        <input type="file" name="jd_file" class="form-control mb-3" required>

        {% if uploaded_jd %}
        <div class="alert alert-info">
            Uploaded JD: <strong>{{ uploaded_jd }}</strong>
        </div>
        {% endif %}

        {% if latest_jd %}
        <div class="alert alert-success">
            Latest JD:
            <strong>{{ latest_jd.jd_text.split('\\')[-1] }}</strong>
        </div>
        {% endif %}

        <label class="form-label mt-3">Minimum Education Required</label>
        <select name="education_requirement" class="form-control mb-3">
            <option value="">None</option>
            <option value="bachelor">Bachelor's</option>
            <option value="master">Master's</option>
            <option value="phd">PhD</option>
        </select>

        <label class="form-label">Minimum Experience (Years)</label>
        <input type="number"
               name="experience_requirement"
               class="form-control mb-3"
               placeholder="e.g., 2">

        <label class="form-label">Gender Requirement (Optional)</label>
        <select name="gender_requirement" class="form-control mb-4">
            <option value="">None</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>

        <button class="btn btn-primary w-100">
            Upload JD & Extract Skills
        </button>
    </form>

    {% if ai_skills %}
    <hr>
    <h5>ðŸ¤– AI Extracted Skills (Editable Scoring)</h5>

    <form action="/confirm_jd" method="post">

        {% for skill in ai_skills %}
        <div class="row mb-2">
            <div class="col">
                <input type="hidden" name="skill_names" value="{{ skill }}">
                <input class="form-control" value="{{ skill }}" readonly>
            </div>
            <div class="col">
                <input type="number"
                       name="skill_scores"
                       class="form-control"
                       value="10"
                       required>
            </div>
        </div>
        {% endfor %}

        <button class="btn btn-success w-100 mt-3">
            Confirm JD & Run Matching
        </button>
    </form>
    {% endif %}
</div>

<!-- ================= SHORTLISTED CANDIDATES ================= -->

{% if shortlisted_candidates %}
<h4 class="mt-4">ðŸŽ¯ Shortlisted Candidates</h4>

<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Score</th>
                <th>Interview Date</th>
                <th>Resume</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>

            {% for entry in shortlisted_candidates %}
            <tr>
                <td>{{ entry.candidate.name }}</td>
                <td>{{ entry.candidate.email }}</td>
                <td>{{ entry.result.score }}%</td>
                <td>
                    {% if entry.result.interview_date %}
                        {{ entry.result.interview_date }}
                    {% else %}
                        Not Scheduled
                    {% endif %}
                </td>

                <td>
                    <a href="/{{ entry.candidate.resume_path }}"
                       target="_blank"
                       class="btn btn-sm btn-primary">
                        View Resume
                    </a>
                </td>

                <td>
                    <button type="button"
                            class="btn btn-sm btn-info"
                            onclick="toggleDetails({{ entry.result.id }})">
                        View Details
                    </button>
                </td>
            </tr>

            <!-- HIDDEN DETAILS ROW -->
            <tr id="details-{{ entry.result.id }}" style="display:none;">
                <td colspan="6">
                    <div class="p-3 bg-light rounded">

                        <h6>ðŸ“Š AI Evaluation Breakdown</h6>

                        {% if entry.result.explanation %}
                        <ul>
                            <li><strong>Semantic Match:</strong>
                                {{ entry.result.explanation.semantic_score }}%
                            </li>

                            <li><strong>Skill Match:</strong>
                                {{ entry.result.explanation.skill_score }}%
                            </li>

                            <li><strong>Matched Skills:</strong>
                                {{ entry.result.explanation.matched_skills }}
                            </li>

                            <li><strong>Education:</strong>
                                {{ entry.result.explanation.education_reason }}
                            </li>

                            <li><strong>Experience:</strong>
                                {{ entry.result.explanation.experience_reason }}
                            </li>

                            <li><strong>Academic Percentages:</strong>
                                <ul>
                                    {% for level, value in entry.result.explanation.academic_percentages.items() %}
                                        <li>{{ level }} : {{ value if value else "Not found" }}%</li>
                                    {% endfor %}
                                </ul>
                            </li>
                        </ul>
                        {% endif %}

                    </div>
                </td>
            </tr>

            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- ================= SCRIPTS ================= -->

<script>
function toggleDetails(id) {
    const row = document.getElementById("details-" + id);
    row.style.display = row.style.display === "none" ? "table-row" : "none";
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const alertBox = document.getElementById("success-alert");

    if (alertBox) {
        setTimeout(function () {
            alertBox.style.transition = "opacity 0.8s ease";
            alertBox.style.opacity = "0";

            setTimeout(function () {
                alertBox.remove();
            }, 800);

        }, 3000);
    }
});
</script>

{% endblock %}